# PRD: 꾸욱(KKOOKK) — POS 연동 없는 디지털 스탬프/리워드 SaaS

---

## 1. 제품 요약

- 꾸욱(KKOOKK)은 카페·소상공인을 위한 **웹 기반 디지털 스탬프/쿠폰 플랫폼**이다.
- 고객은 앱 설치 없이 QR로 즉시 접속해 적립/리딤을 요청한다.
- 적립/리딤 확정은 **매장(사장님 계정으로 로그인된 단말) 승인**으로 완료된다.
- 사장님은 백오피스에서 **StampCard(스탬프 카드) 디자인/규칙 설정** 및 **로그/통계**로 재방문 구조를 만든다.
- POS 연동 없이도 운영 가능한 “현장 승인형” 스탬프 리워드 SaaS를 목표로 한다.
- 도입 초기 전환 장벽을 낮추기 위해 **기존 종이 스탬프를 사진으로 등록(수동 반영)**하는 마이그레이션 기능을 제공한다.

---

## 2. 목표 / 성공지표 (Metrics)

### 2.1 핵심 KPI

- 적립 요청 → 승인 완료율
- 리딤 요청 → 사용 완료율
- 재방문율(D7 / D30)
- 리워드 사용률(리딤율)
- 부정 시도 차단율(만료/중복/레이트리밋/스텝업 인증으로 실패한 비율)
- CS 이슈 해결 리드타임(적립/리딤 누락/이전 등록 처리)

### 2.2 퍼널 KPI

1. 매장 진입(Scan)
2. (최초 1회) OTP 완료 + 프로필 입력
3. 지갑 생성/접속
4. 적립 요청 생성
5. 매장 승인
6. 적립 완료
7. 리딤(사용하기)
8. **OTP(스텝업 인증) 완료**
9. 매장 확인(고객폰에서 누름)
10. 사용 완료
11. (선택) 기존 종이 스탬프 사진 등록 → 수동 반영 완료

---

## 3. 사용자 / 테넌트 구조

### 3.1 테넌트 구조

- **OwnerAccount(사장님 계정)** → **Store(매장)** N개 → **StampCard** N개
- 고객은 **Wallet(지갑)** 단위로 여러 Store/StampCard를 보유

### 3.2 사용자 유형

- **사장님(Owner)**: 백오피스 + 매장 단말에서 운영/승인 수행
- **고객(Customer)**: 웹에서 조회/적립 요청/리딤 요청 수행

> 매장 운영은 “사장님 계정 1개”로 통합(직원도 동일 계정 사용)
> 

---

## 4. 플랫폼 구성

- 고객 Web(모바일 웹)
- 사장님 백오피스 Web(PC)
- 매장 단말 Web(태블릿/PC/스마트폰)
    - 사장님 계정으로 로그인해 승인 화면을 상시 띄워 운영

---

## 5. 핵심 유저 시나리오

### 5.1 사장님 온보딩 (Backoffice)

1. 사장님 회원가입/로그인
2. 매장 등록
3. **StampCard 생성**(템플릿 → 디자인 → 규칙)
4. 매장 고정 QR 생성(storeId 기반)
5. 매장 단말 로그인 → 승인 화면 상시 운영
6. 테스트 적립/리딤 시뮬레이션

### 5.2 고객 플로우 (Customer Web)

- QR → 매장 StampCard로 즉시 접근
- (최초 1회) 전화번호 OTP + 이름 + 닉네임 입력 → 지갑 생성
- 이후 재방문/조회: 전화번호 + 이름 → 지갑 접근(조회 가능)
- 적립하기 → 승인 대기 → 매장 승인 → 적립 완료
- 리워드 달성 시 사용하기 → **리딤 시 OTP 필수(스텝업)** → “사장님이 눌러주세요” → 매장 확인 클릭 → 사용 완료
- (선택) **기존 종이 스탬프 사진 등록** → 운영측(우리/사장님)이 확인 후 **스탬프 반영**

---

# 6. 기능 요구사항 (Functional Requirements)

## 6.1 고객 Web — “스탬프 지갑”

### 6.1.1 진입/인증

### QR 진입

- QR 링크는 `storeId` 포함
- 진입 시 해당 매장의 Active StampCard를 기본 표시

### 최초 1회 등록(강화)

- 입력: 전화번호 + OTP + 이름 + 닉네임
- 생성: Wallet 생성

### 이후 지갑 접근(조회 목적)

- 입력: **전화번호 + 이름**
- 방어(필수):
    - IP/디바이스/번호 레이트리밋
    - 실패 누적 시 쿨다운
    - 의심 패턴 시 “추가 인증 필요” 안내

### 스텝업 인증 정책(필수)

- 아래 액션은 **항상 OTP 인증 완료 상태**에서만 가능:
    - **리워드 사용(리딤)**
    - (옵션) 지갑 내 개인정보 수정, 계정 복구
- OTP 인증은 세션 단위로 일정 시간 유효(예: 10분)
    - 만료 시 재인증

---

### 6.1.2 지갑 홈

- StampCard 목록(진행률, 만료, 다음 보상)
- 리워드 보관함(사용 가능/만료 임박)
- 적립/사용 히스토리
- (선택) “기존 종이 스탬프 등록하기” 진입 버튼

---

### 6.1.3 스탬프 적립 (직원 승인 기반) — Polling 고정

### 고객 화면 플로우

1. “적립하기” 클릭
2. `IssuanceRequest` 생성(1회성, TTL)
3. “승인 대기 중” 화면(상태 자동 갱신)
4. 매장 승인 시 자동 완료

### 승인 대기 화면 UX(필수)

- “적립 승인 대기 중” + 남은 시간(카운트다운)
- 상태 자동 갱신 방식: **Polling 고정**
    - 예: 2~3초 간격으로 `IssuanceRequest.status` 조회
- TTL 만료 시 재요청 유도
- 하단에 “요청번호”는 CS 대응용으로만 작게 노출

### 매장 단말 플로우

- 승인 대기 목록에서 해당 요청 승인/거절

### 최소 부정 방지(필수)

- TTL 60~120초, 1회성, 멱등성
- Wallet+Store 쿨다운/일일 제한
- IP/디바이스 레이트리밋

---

### 6.1.4 리워드 사용(리딤) — OTP + “2차 확인 모달” + TTL 만료(필수)

### 목표

- 고객이 리워드에서 [사용하기]로 “사용 요청”을 만든다.
- **사용 완료는 매장 측이 고객 폰에서 확인 동작을 수행해야만 확정**된다.
- 고객 혼자 실수로 누르거나 악용하는 것을 막는 장치를 **필수**로 제공한다.

### 전체 플로우

1. 고객이 리워드 상세에서 **[사용하기]** 클릭
2. 시스템이 **OTP(스텝업 인증) 상태** 확인
    - 미인증이면: OTP 인증 플로우로 이동 → 완료 후 3) 진행
3. 서버가 `RedeemSession` 생성(TTL: 30~60초)
4. 고객 화면이 “매장 확인 화면”으로 전환
5. **매장 측 확인 동작 완료** → 사용 완료 처리

### 고객 “매장 확인 화면” UI(필수)

- 제목: “매장에서 확인 중”
- 버튼: “사용 처리”
- 안전장치(필수):
    - **(필수-1) 2차 확인 모달**
        - 문구: “지금 사용 처리하면 되돌릴 수 없습니다. 매장에서 확인 후 진행해 주세요.”
        - 버튼: [취소] / [확인]
    - **(필수-2) 짧은 TTL + 만료 처리**
        - TTL 내 미완료 시 자동 만료 → 다시 [사용하기] 유도
        - 만료 시 화면에 “요청이 만료되었습니다” 안내

### 매장 측 확인 방식(필수)

- 매장 측은 고객 폰 화면에서 “사용 처리”를 누르고 → 모달 확인까지 진행한다.
- 완료 시 서버는 `RedeemSession`을 `COMPLETED`로 전환하고 `RedeemEvent` 원장 로그 기록.

### 분쟁/오류 대응(필수)

- 사용 완료 기록은 “시간/매장/StampCard/리워드/세션ID”로 조회 가능해야 함
- 중복 사용 방지(멱등성): 동일 리워드는 1회만 `COMPLETED`

---

### 6.1.5 기존 종이 스탬프 사진 등록 — (수동 반영)

### 목적

- 서비스 도입 이전에 고객이 종이 쿠폰에 모아둔 스탬프를 **전환 장벽 없이 디지털로 이전**할 수 있게 한다.
- 초기에는 자동 인식(OCR) 없이 **운영자가 사진을 보고 수동으로 스탬프 수를 반영**한다.

### 고객 플로우

1. 지갑 홈 → “기존 종이 스탬프 등록하기”
2. 매장 선택(= 현재 store 컨텍스트 기본) + StampCard 선택(Active 1개면 자동)
3. 사진 업로드(종이 스탬프 카드 사진)
4. 안내 문구:
    - “사진 확인 후 반영까지 시간이 걸릴 수 있어요(예: 24~48시간).”
    - “악용 방지를 위해 1회 또는 제한된 횟수만 신청 가능할 수 있어요.”
5. 제출 완료 → 상태 화면에서 처리 진행 상태 확인

### 운영/사장님 플로우(초기 운영 방식)

- 백오피스에 “이전 요청 목록” 제공
- 목록에서 사진 확인 → “인정 스탬프 수 입력” → 반영(승인) / 반려(사유)
- 반영 시:
    - `WalletStampCard.stampCount`를 **추가 증가**
    - `StampEvent(type=MIGRATED)` 기록(원장으로 남김)
- 반려 시: 반려 사유 저장 + 고객에게 상태 표시

### 정책(필수, 악용 방지)

- (MVP 정책 선택)
    - Wallet당 **이전 요청 1회 제한**(또는 Store당 1회)
    - 제출 후 **처리 완료/반려 전까지 재신청 불가**
- 사진 보관
    - 저장 기간 정책 필요(예: 30일 후 삭제)
    - 개인정보/민감정보 가능성(영수증/메모 등) 안내 문구 포함

### 데이터 모델(추가 엔티티)

- `StampMigrationRequest`
    - `id`, `walletId`, `storeId`, `stampCardId`
    - `imageUrl`
    - `status` (SUBMITTED / APPROVED / REJECTED / CANCELED)
    - `requestedAt`, `processedAt`
    - `approvedStampCount` (운영 입력)
    - `rejectReason` (옵션)

---

## 6.2 사장님 백오피스 Web — “StampCard/운영/통계”

### 6.2.1 매장/StampCard 관리

- 매장 정보 관리
- StampCard CRUD
- 상태: Draft / Active / Paused / Archived

### 6.2.2 StampCard 디자인(템플릿)

- 템플릿 제공
- 커스텀 편집
- 매장 QR 포스터 PDF 생성

### 6.2.3 AI 디자인(확장)

- 시안 생성/편집/확정
- 정책: 필터링/고지/이력

### 6.2.4 리워드 규칙/정책

- N회 적립 → 리워드
- 유효기간/적립 제한
- 수동 적립/차감(사유 필수 + 로그)

### 6.2.5 로그/감사(운영/분쟁)

- 적립/리딤 검색(기간/지갑/StampCard)
- 이상 징후(요청 폭주, 실패 폭주 등)

### 6.2.6 기존 종이 스탬프 “이전 요청” 처리

- 이전 요청 목록/상세(이미지 뷰어)
- 승인: 인정 스탬프 수 입력 → 반영
- 반려: 사유 입력 → 고객에 표시
- 처리 로그 남김(감사/분쟁 대응)

---

## 6.3 매장 단말 Web — “승인 화면(사장님 계정 공용)”

### 6.3.1 적립 승인

- 승인 대기 목록 표시
- 승인/거절

### 6.3.2 리딤 확인 보조(권장 → 유지)

- “리딤 요청이 진행 중” 상태를 단말에서 표시
- 매장 측이 고객 폰을 조작하기 전, 해당 지갑/리워드가 맞는지 빠르게 확인 가능

### 6.3.3 실시간/인프라

- (MVP) **Polling 기반** 운영(단말에서도 일정 주기로 목록 갱신 가능)
- Redis: TTL/대기열/레이트리밋/멱등성 (확장)

---

## 7. 데이터/이벤트 모델

### 7.1 핵심 엔티티

- OwnerAccount, Store
- StampCard, RewardRule
- CustomerWallet(phone, name, nickname)
- WalletStampCard(진행률)
- IssuanceRequest
- StampEvent(원장)
- RedeemSession
- RedeemEvent
- **StampMigrationRequest(신규)**

### 7.2 원칙

- 진행률은 캐시/집계 가능
- 분쟁/정산은 이벤트 원장으로 복구 가능해야 함
- “기존 이전 반영”도 StampEvent에 `MIGRATED`로 남겨야 함

---

## 8. 보안/부정 방지(필수)

### 8.1 요청/세션 보안

- QR은 정적 storeId 진입용
- IssuanceRequest/RedeemSession은 TTL + 1회성 + 멱등성

### 8.2 지갑 접근 공격 방어

- “전화번호+이름 조회”는 추측 위험 → 레이트리밋/쿨다운/의심 시 스텝업
- 리딤은 무조건 OTP 완료 상태에서만 가능

### 8.3 감사로그

- 적립/리딤/이전 반영은 최소 기록:
    - walletId, storeId, stampCardId, time, requestId/sessionId, result

---

## 9. 비기능 요구사항(NFR)

- 승인 반영 P95 < 1s (MVP는 폴링이므로 “승인 후 2~3초 내 반영” 기준으로 측정)
- 가용성 99.5%(MVP) → 99.9%
- 관측성: 트레이싱/알림
- 보안: 세션 만료/CSRF/관리자 액션 로그

---

## 10. 엣지 케이스/정책

- StampCard 여러 개일 때: Active 1개 기본 / 확장 시 선택 UI
- 승인 대기 중 이탈: TTL 내 복원
- 리딤 오작동: **OTP + 2차 확인 모달 + TTL 만료(필수)**
- 이름 오타로 접근 실패: 의심 시 OTP 재요구 옵션
- 기존 종이 스탬프 이전:
    - 1회 제한/재신청 제한 정책
    - 사진 처리 SLA 안내(24~48시간 등)

---

## 11. MVP 범위

### MVP-1

- QR 진입
- 최초 OTP + 이름/닉네임 등록
- 조회 접근(전화+이름)
- 적립 요청 + 승인 대기(**Polling**) + 매장 승인 + 적립 완료
- 리딤: 사용하기 + **OTP 필수(스텝업)** + **2차 확인 모달 + TTL 만료** + 사용 완료
- 기존 종이 스탬프 “사진 등록” + 운영 수동 반영(간단 승인 UI)
- 매장: StampCard 생성 + QR 출력 + 승인 화면 + 로그 조회
- 방어: TTL/멱등성/레이트리밋/감사로그

### MVP-2

- 마케팅, AI 디자인, 위치 기반/랭킹(정책 검토 후)
- 자동 OCR/AI 판독(사진 자동 계산)
- PWA 도입
