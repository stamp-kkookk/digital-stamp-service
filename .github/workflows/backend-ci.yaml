name: Backend CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yaml'

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  JAVA_VERSION: '17'
  WORKING_DIRECTORY: backend

jobs:
  # ============================================
  # Job 1: Build & Test
  # ============================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build
        run: ./gradlew build -x test --no-daemon

      - name: Run Tests
        run: ./gradlew test --no-daemon

      - name: Generate Jacoco Report
        run: ./gradlew jacocoTestReport --no-daemon

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: ${{ env.WORKING_DIRECTORY }}/build/reports/tests/test/
          retention-days: 7

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.WORKING_DIRECTORY }}/build/reports/jacoco/test/html/
          retention-days: 7

      - name: Jacoco Coverage Report to PR
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ env.WORKING_DIRECTORY }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 60
          min-coverage-changed-files: 60
          title: "ğŸ“Š Coverage Report"
          update-comment: true

  # ============================================
  # Job 2: Code Quality (Checkstyle + Spotless)
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Spotless Check
        id: spotless
        run: ./gradlew spotlessCheck --no-daemon
        continue-on-error: true

      - name: Checkstyle
        id: checkstyle
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon
        continue-on-error: true

      - name: Upload Checkstyle Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkstyle-report
          path: ${{ env.WORKING_DIRECTORY }}/build/reports/checkstyle/
          retention-days: 7

      - name: Check Results
        run: |
          if [ "${{ steps.spotless.outcome }}" == "failure" ] || [ "${{ steps.checkstyle.outcome }}" == "failure" ]; then
            echo "::error::Code quality checks failed"
            exit 1
          fi

  # ============================================
  # Job 3: Coverage Gate
  # ============================================
  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    needs: build-and-test
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Verify Coverage Threshold
        run: ./gradlew test jacocoTestCoverageVerification --no-daemon

  # ============================================
  # Job 4: Summary Comment
  # ============================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, coverage-gate]
    if: always()

    steps:
      - name: Create Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const buildResult = '${{ needs.build-and-test.result }}';
            const qualityResult = '${{ needs.code-quality.result }}';
            const coverageResult = '${{ needs.coverage-gate.result }}';

            const getEmoji = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                default: return 'âš ï¸';
              }
            };

            const getStatus = (result) => {
              switch(result) {
                case 'success': return 'Passed';
                case 'failure': return 'Failed';
                case 'skipped': return 'Skipped';
                default: return 'Unknown';
              }
            };

            const allPassed = buildResult === 'success' &&
                              qualityResult === 'success' &&
                              coverageResult === 'success';

            const header = allPassed
              ? '## âœ… Backend CI Passed'
              : '## âŒ Backend CI Failed';

            const body = `${header}

            | Check | Status |
            |-------|--------|
            | ${getEmoji(buildResult)} Build & Test | ${getStatus(buildResult)} |
            | ${getEmoji(qualityResult)} Code Quality | ${getStatus(qualityResult)} |
            | ${getEmoji(coverageResult)} Coverage Gate | ${getStatus(coverageResult)} |

            <details>
            <summary>ğŸ“‹ CI Gates ìƒì„¸</summary>

            ### Build & Test
            - Gradle ë¹Œë“œ
            - JUnit5 í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            - Jacoco ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±

            ### Code Quality
            - **Spotless**: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
            - **Checkstyle**: ì½”ë”© ì»¨ë²¤ì…˜ ê²€ì‚¬

            ### Coverage Gate
            - Line Coverage â‰¥ 60%
            - Branch Coverage â‰¥ 50%

            </details>

            ${!allPassed ? `
            > ğŸ’¡ **Tip**: ë¡œì»¬ì—ì„œ \`./gradlew check\`ë¥¼ ì‹¤í–‰í•˜ì—¬ CIì™€ ë™ì¼í•œ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ` : ''}

            ---
            *Workflow: [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Backend CI')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
