# Gemini 가이드: 백엔드 설계 리뷰

## Summary
- **Objective**: Use this guide to perform a comprehensive review of a backend design (logic or API) based on a detailed checklist.
- **Trigger**: When asked to review a backend design.
- **Input**: The design document to be reviewed.

## 1. 설계 리뷰 요청 접수 시 확인 사항

백엔드 설계 리뷰 요청을 받으면, 먼저 `/guides/be-logic-design.md` 또는 `/guides/be-api-design.md`에 따라 작성된 **리뷰할 설계 문서**가 있는지 확인합니다.

## 2. 설계 리뷰 체크리스트

설계 문서를 다음 체크리스트에 따라 체계적으로 검토합니다.

### 2.1. 보안 (Security)
- [ ] **인증 (Authentication)**: API에 적절한 인증 절차가 적용되었는가?
- [ ] **인가 (Authorization)**: 사용자가 자신의 리소스에만 접근할 수 있도록 인가 로직(소유권 검증 등)이 명확한가?
- [ ] **입력 유효성 검증**: Bean Validation 등을 통해 모든 외부 입력값이 검증되는가?
- [ ] **Rate Limiting**: 무차별 대입 공격(brute-force) 등에 대비한 요청 제한 정책이 필요한가?
- [ ] **민감 정보**: 비밀번호, 개인정보 등이 로그에 남지 않도록 처리되었는가?

### 2.2. 멱등성 (Idempotency)
- [ ] **중복 요청 처리**: 사용자가 동일한 요청을 여러 번 보낼 경우를 대비한 처리 방안이 있는가? (GET, PUT, DELETE는 멱등해야 함)
- [ ] **Idempotency Key**: POST 요청의 중복 실행을 막기 위해 idempotency key가 필요한가?
- [ ] **고유 제약 조건**: 데이터베이스 레벨에서 중복을 방지하기 위한 고유 제약 조건(unique constraint)을 활용하는가?

### 2.3. TTL / 만료 (Time-to-Live / Expiry)
- [ ] **세션/토큰 만료**: 인증 세션이나 토큰의 만료 정책이 명확한가?
- [ ] **요청 타임아웃**: 오래 걸리는 요청에 대한 타임아웃이 설정되어 있는가?
- [ ] **만료 데이터 처리**: 만료된 데이터를 정리하기 위한 스케줄링 작업이 필요한가?

### 2.4. 트랜잭션 (Transaction)
- [ ] **트랜잭션 경계**: 트랜잭션이 시작되고 끝나는 범위가 명확하며, 비즈니스 로직 단위와 일치하는가?
- [ ] **롤백 조건**: 어떤 예외 상황에서 트랜잭션이 롤백되어야 하는지 정의되었는가?
- [ ] **데드락**: 여러 트랜잭션이 동시에 같은 리소스에 접근할 때 데드락(교착 상태) 발생 가능성은 없는가?

### 2.5. 에러 처리 (Error Handling)
- [ ] **일관된 형식**: 모든 에러 응답이 프로젝트의 표준 형식(code, message, timestamp)을 따르는가?
- [ ] **적절한 상태 코드**: HTTP 상태 코드가 에러 상황에 맞게 사용되었는가? (400, 401, 403, 404, 500 등)
- [ ] **사용자 친화적 메시지**: 에러 메시지가 사용자가 이해하기 쉽고, 다음 행동을 유추하는 데 도움이 되는가?

### 2.6. 성능 (Performance)
- [ ] **N+1 쿼리**: 연관 관계 조회 시 N+1 쿼리 문제가 발생할 가능성은 없는가? (Fetch Join 등 고려)
- [ ] **인덱스**: 쿼리의 `WHERE`, `JOIN` 절에 사용되는 컬럼에 인덱스가 적절히 정의되었는가?
- [ ] **페이징**: 목록을 조회하는 API에 페이징이 올바르게 적용되었는가?

### 2.7. 동시성 (Concurrency)
- [ ] **Race Condition**: 여러 요청이 동시에 공유 리소스를 변경할 때 Race Condition이 발생할 가능성은 없는가?
- [ ] **Locking**: 동시성 문제를 해결하기 위해 낙관적 락(optimistic lock) 또는 비관적 락(pessimistic lock)이 필요한가?

## 3. 리뷰 결과 제안 형식

검토가 끝나면, 다음 형식에 맞춰 리뷰 결과를 구조화하여 제안합니다.

```markdown
## {리뷰_대상} 설계 리뷰 요약

### 통과 항목
- {체크리스트의 통과 항목}
- 예: [x] 인증/인가 로직이 명확하고 안전합니다.

### 개선 제안
- {체크리스트의 개선 필요 항목과 해결 방안}
- 예: [ ] **Rate Limiting 추가**: 무차별 대입 공격 방지를 위해 로그인 API에 Rate Limiting 적용을 권장합니다.

### 위험 요소
- {설계에 내재된 잠재적 위험과 해결 방안}
- 예: **동시성 문제**: 스탬프 동시 발급 요청 시 중복 적립 가능성이 있습니다. `wallet_id`와 `stamp_card_id`에 유니크 제약 조건을 추가해야 합니다.
```
